import sys
import os
import time
import json
import re
import requests
import openpyxl
from datetime import datetime, timedelta
from collections import defaultdict
from configparser import ConfigParser
from PyQt5.QtWidgets import (
    QApplication, QWidget, QLineEdit, QPushButton, QVBoxLayout,
    QHBoxLayout, QFileDialog, QMessageBox, QDateTimeEdit, QGroupBox, QLabel,
    QProgressBar
)
from PyQt5.QtCore import QDateTime, QTime, QRunnable, pyqtSignal, QObject, QThreadPool, QTimer, Qt, QByteArray
from PyQt5.QtGui import QPixmap, QIcon

# =========================
#  å¸¸é‡ï¼šchunk ä¸»æœºä¸æ–‡ä»¶ï¼ˆå†™æ­»ï¼Œç”¨æˆ·ä¸å¯è§ï¼‰
# =========================
CHUNK_HOST = "v.boinht.com"
CHUNK_FILE = "chunk-e0740300.5b088cd2.js"

# å¯é€‰è°ƒè¯•å¼€å…³ï¼ˆTrue ä¼šæ‰“å°å°‘é‡å…³é”®æ—¥å¿—ï¼›False é™é»˜ï¼‰
DEBUG = False

# =========================
#  å¤–ç½®ï¼šä»…ä¿ç•™æ ‡ç­¾è§„åˆ™ï¼ˆåˆ¤åæ¥è‡ª chunkï¼‰
# =========================
TAG_RULES_FILE = "tag_rules.json"

DEFAULT_TAG_RULES = {
    "defaults_by_platform": {
        "æ±æ–¹å½©ç¥¨": "å½©ç¥¨å®¢",
        "æ±æ–¹å½©ç¥¨å¤§å…": "å½©ç¥¨å®¢",
        "KYæ£‹ç‰Œ": "æ£‹ç‰Œå®¢",
        "JDBå¥ªå¯¶é›»å­": "ç”µå­å®¢",
        "AGè¦–è¨Šé›»å­": "è§†è®¯å®¢",
        "DGè¦–è¨Š": "è§†è®¯å®¢",
        "VRå½©ç¥¨": "å½©ç¥¨å®¢",
        "WMå®Œç¾è¦–è¨Š": "è§†è®¯å®¢",
        "PTæ£‹ç‰Œ": "æ£‹ç‰Œå®¢",
        "é¾åŸæ£‹ç‰Œ": "æ£‹ç‰Œå®¢",
        "BGæ£‹ç‰Œ": "æ£‹ç‰Œå®¢",
        "CQ9æ£‹ç‰Œ": "ç”µå­å®¢",
        "äºæ˜Ÿè¦–è¨Š": "è§†è®¯å®¢",
        "åšä¹æ£‹ç‰Œ": "æ£‹ç‰Œå®¢",
        "å‡±æ—‹æ£‹ç‰Œ": "æ£‹ç‰Œå®¢",
        "FCå‘è´¢ç”µå­": "ç”µå­å®¢",
        "ç“¦åŠ›æ¸¸æˆ": "æ£‹ç‰Œå®¢",
        "BBIN": "æ£‹ç‰Œå®¢",
        "ç¯äºšæ£‹ç‰Œ": "æ£‹ç‰Œå®¢",
        "ä¹æ¸¸æ£‹ç‰Œ": "æ£‹ç‰Œå®¢",
        "CRä½“è‚²": "ä½“è‚²å®¢",
        "PGç”µå­": "ç”µå­å®¢",
        "TP": "ç”µå­å®¢",
        "MG": "ç”µå­å®¢"
    },
    "rules": [
        {
            "priority": 101,
            "platform_in": ["KYæ£‹ç‰Œ"],
            "game_name_contains_any": ["é«”è‚²"],
            "tag": "ä½“è‚²å®¢"
        },
        {
            "priority": 100,
            "platform_in": ["KYæ£‹ç‰Œ"],
            "game_name_contains_any": ["æ•é­š", "é‡‘é¯Š"],
            "tag": "æ•é±¼å®¢"
        },
        {
            "priority": 100,
            "platform_in": ["JDBå¥ªå¯¶é›»å­", "AGè¦–è¨Šé›»å­", "DGè¦–è¨Š", "WMå®Œç¾è¦–è¨Š", "BGæ£‹ç‰Œ", "åšä¹æ£‹ç‰Œ", "CQ9æ£‹ç‰Œ",
                            "ç“¦åŠ›æ¸¸æˆ", "FCå‘è´¢ç”µå­"],
            "game_name_contains_any": ["æ•é­š", "æ¼å ´"],
            "tag": "æ•é±¼å®¢"
        },
        {
            "priority": 90,
            "platform_in": ["ç“¦åŠ›æ¸¸æˆ"],
            "game_name_contains_any": ["è¦–è¨Š"],
            "tag": "è§†è®¯å®¢"
        }
    ],
    "fallback": "æœªåˆ†ç±»"
}


# =========================
#  å·¥å…·ï¼šè·¯å¾„/è¯»å†™
# =========================
def program_dir() -> str:
    return os.path.dirname(os.path.abspath(sys.argv[0]))


def tag_rules_path() -> str:
    return os.path.join(program_dir(), TAG_RULES_FILE)


def write_tag_rules_template_if_missing():
    p = tag_rules_path()
    if not os.path.exists(p):
        with open(p, "w", encoding="utf-8") as f:
            json.dump(DEFAULT_TAG_RULES, f, ensure_ascii=False, indent=2)


def _validate_tag_rules(data: dict):
    if not isinstance(data, dict):
        raise ValueError("tag_rules.json é¡¶å±‚å¿…é¡»æ˜¯å¯¹è±¡ã€‚")
    if not isinstance(data.get("defaults_by_platform", {}), dict):
        raise ValueError("defaults_by_platform å¿…é¡»æ˜¯å¯¹è±¡ã€‚")
    if not isinstance(data.get("rules", []), list):
        raise ValueError("rules å¿…é¡»æ˜¯æ•°ç»„ã€‚")
    if not isinstance(data.get("fallback", "æœªåˆ†ç±»"), str):
        raise ValueError("fallback å¿…é¡»æ˜¯å­—ç¬¦ä¸²ã€‚")


def load_tag_rules_with_fallback(parent_widget=None) -> dict:
    p = tag_rules_path()
    try:
        with open(p, "r", encoding="utf-8") as f:
            data = json.load(f)
        _validate_tag_rules(data)
        return data
    except FileNotFoundError:
        write_tag_rules_template_if_missing()
        if parent_widget:
            QMessageBox.information(parent_widget, "æç¤º", f"æœªæ‰¾åˆ° {TAG_RULES_FILE}ï¼Œå·²ç”Ÿæˆæ¨¡æ¿ï¼Œå°†ä½¿ç”¨é»˜è®¤è§„åˆ™è¿è¡Œã€‚")
        return json.loads(json.dumps(DEFAULT_TAG_RULES, ensure_ascii=False))
    except Exception as e:
        if parent_widget:
            QMessageBox.warning(parent_widget, "è§„åˆ™è¯»å–å¤±è´¥", f"{TAG_RULES_FILE} è§£æå¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤è§„åˆ™è¿è¡Œã€‚\n\n{e}")
        return json.loads(json.dumps(DEFAULT_TAG_RULES, ensure_ascii=False))


# =========================
#  æŠ“å– & è§£æ chunkï¼šå¾—åˆ° ChessPIDs / ChessList
# =========================
def _http_get(url, token, timeout=10, retries=2):
    headers = {'Cookie': f'token={token}', 'User-Agent': 'Mozilla/5.0'}
    last_err = None
    for attempt in range(retries + 1):
        try:
            if DEBUG: print(f"[DBG] GET {url} (try {attempt + 1})")
            r = requests.get(url, headers=headers, timeout=timeout)
            if DEBUG: print("[DBG] status =", r.status_code, "len =", len(r.text or ""))
            if r.status_code == 200 and r.text:
                return r.text
            last_err = f"HTTP {r.status_code}"
        except Exception as e:
            last_err = str(e)
            if DEBUG: print("[DBG] exception:", last_err)
        time.sleep(1)
    raise RuntimeError(f"GET {url} å¤±è´¥ï¼š{last_err}")


def _find_balanced_block(text, start_idx, open_char='{', close_char='}'):
    i = text.find(open_char, start_idx)
    if i == -1: return None, -1
    depth, j = 0, i
    while j < len(text):
        c = text[j]
        if c == open_char:
            depth += 1
        elif c == close_char:
            depth -= 1
            if depth == 0:
                return text[i:j + 1], j + 1
        j += 1
    return None, -1


def _clean_js_for_json(js_text, const_map=None):
    import re, json
    t = js_text.strip()
    t = t.replace('\r', '').replace('\n', ' ')
    t = t.replace("'", '"')
    t = t.replace('!0', 'true').replace('!1', 'false')
    t = re.sub(r",\s*([}\]])", r"\1", t)

    # å¸¸é‡æ›¿æ¢ï¼šæ”¯æŒä»»æ„å˜é‡å & ä»»æ„å¸¸é‡ï¼ˆåŒ…å« GAME_TYPE_*ï¼‰
    if const_map:
        def repl_const(m):
            full = m.group(1)  # å˜é‡å.å¸¸é‡å
            suf = m.group(2)  # å¸¸é‡åï¼ˆåç¼€ï¼‰
            val = const_map.get(full, const_map.get(suf))
            if val is None:
                return full
            return json.dumps(val, ensure_ascii=False)

        t = re.sub(r'([A-Za-z_$][\w$]*\.([A-Z0-9_]+))', repl_const, t)

    # é”®åè¡¥å¼•å·
    t = re.sub(r'\{\s*([A-Za-z0-9_\-]+)\s*:', r'{"\1":', t)
    t = re.sub(r',\s*([A-Za-z0-9_\-]+)\s*:', r',"\1":', t)
    return t


def parse_chunk_for_chess(text):
    """
    è¿”å›ï¼š
      platform_names: {pid -> å¹³å°ä¸­æ–‡å}
      chess_list: {"ky":[{id,name,params,...},...], ...}
    """
    import re, json

    # å¸¸é‡è¡¨ï¼ˆä»»æ„å˜é‡å.å¸¸é‡ï¼Œæ”¯æŒå­—ç¬¦ä¸²æˆ–æ•°å­—ï¼‰
    const_map = {}
    for m in re.finditer(
            r'([A-Za-z_$][\w$]*\.([A-Z0-9_]+))\s*=\s*(?:"([^"]+)"|([0-9]+))',
            text
    ):
        full_name = m.group(1)  # å¦‚ m.GAME_PLATFORM_TYPE_KYQP / m.GAME_TYPE_FS_QP
        suffix = m.group(2)  # å¦‚ GAME_PLATFORM_TYPE_KYQP / GAME_TYPE_FS_QP
        str_val = m.group(3)
        num_val = m.group(4)
        value = str_val if str_val is not None else (int(num_val) if num_val is not None else None)
        if value is not None:
            const_map[full_name] = value
            const_map[suffix] = value

    # ChessPIDs
    m_pids = re.search(r'ChessPIDs\s*=\s*', text)
    if DEBUG: print("[DBG] has ChessPIDs =", bool(m_pids))
    platform_names = {}
    if m_pids:
        start = text.find('[', m_pids.end())
        block, _ = _find_balanced_block(text, start, '[', ']')
        if block:
            pids_json = _clean_js_for_json(block, const_map)
            pids_arr = json.loads(pids_json)
            for item in pids_arr:
                pid = item.get('pid')
                name = item.get('name')
                if pid and name and pid != "":
                    platform_names[pid] = name
    if DEBUG: print("[DBG] platform_names count =", len(platform_names))

    # ChessList
    m_list = re.search(r'ChessList\s*=\s*', text)
    if DEBUG: print("[DBG] has ChessList =", bool(m_list))
    chess_list = {}
    if m_list:
        obj_text, _ = _find_balanced_block(text, m_list.end(), '{', '}')
        if obj_text:
            list_json = _clean_js_for_json(obj_text, const_map)
            chess_list = json.loads(list_json)
            if DEBUG: print("[DBG] chess_list keys =", list(chess_list.keys())[:10])

    return platform_names, chess_list


# =========================
#  æŒ‰å‰ç«¯é€»è¾‘â€œåˆ¤åâ€
# =========================
def _to_int(v):
    try:
        return int(v)
    except Exception:
        return v


def resolve_game_name(pid, game_type, chess_list_for_pid):
    if not chess_list_for_pid or not isinstance(chess_list_for_pid, list):
        return ""
    a = game_type
    if isinstance(a, str):
        try:
            a = json.loads(a)
        except Exception:
            return ""
    if not isinstance(a, dict):
        return ""

    for p in chess_list_for_pid:
        params = p.get('params', {})
        name = p.get('name', '')
        if not name or not isinstance(params, dict):
            continue
        try:
            if pid in ('ky', 'lc', 'kxqp', 'kxbp'):
                if 'KindID' in params and _to_int(params['KindID']) == _to_int(a.get('KindID')): return name
            elif pid == 'jdb':
                if _to_int(params.get('gType')) == _to_int(a.get('gType')) and _to_int(params.get('mType')) == _to_int(
                    a.get('mType')): return name
            elif pid == 'ag':
                if params.get('gameType') == a.get('gameType'): return name
            elif pid == 'dg':
                if params.get('gameId') == a.get('gameId'): return name
            elif pid == 'vr':
                if _to_int(params.get('channelId')) == _to_int(a.get('channelId')): return name
            elif pid == 'wm':
                if params.get('mode') == a.get('mode'): return name
            elif pid == 'pt':
                if params.get('PtGame') == a.get('PtGame'): return name
            elif pid == 'bg':
                if params.get('BG_GameId') == a.get('BG_GameId') and params.get('BG_GameType') == a.get(
                    'BG_GameType'): return name
            elif pid == 'xj':
                if params.get('xj_gameType') == a.get('xj_gameType'): return name
            elif pid == 'cq9':
                if params.get('gameCode') == a.get('gameCode'):
                    if 'tableType' in a:
                        if params.get('tableType') == a.get('tableType'):
                            return name
                        else:
                            continue
                    return name
            elif pid in ('ebet', 'wnsr'):
                if params.get('gameCode') == a.get('gameCode'): return name
            elif pid == 'jbcp':
                if _to_int(params.get('jbcpType')) == _to_int(a.get('jbcpType')): return name
            elif pid == 'cp_lobby':
                if _to_int(params.get('cpLobbyType')) == _to_int(a.get('cpLobbyType')): return name
            elif pid == 'yxsx':
                if _to_int(params.get('yxsxType')) == _to_int(a.get('yxsxType')): return name
            elif pid == 'dt':
                if _to_int(params.get('dtType')) == _to_int(a.get('dtType')): return name
            elif pid == 'blqp':
                if _to_int(params.get('Bl1')) == _to_int(a.get('Bl1')) and _to_int(params.get('Bl2')) == _to_int(
                        a.get('Bl2')):
                    if 'Bl3' in a:
                        if _to_int(params.get('Bl3')) == _to_int(a.get('Bl3')):
                            return name
                        else:
                            continue
                    return name
            elif pid == 'fc':
                if _to_int(params.get('FcType')) == _to_int(a.get('FcType')): return name
            elif pid == 'wl':
                if _to_int(params.get('WlType')) == _to_int(a.get('WlType')): return name
            elif pid == 'hy':
                if _to_int(params.get('HyType')) == _to_int(a.get('HyType')): return name
            elif pid == 'cr':
                if params.get('cr_gameType') == a.get('cr_gameType'): return name
            elif pid == 'lm':
                if params.get('LmType') == a.get('LmType'): return name
            elif pid == 'pg':
                if _to_int(params.get('PgType')) == _to_int(a.get('PgType')): return name
            elif pid == 'ly':
                if _to_int(params.get('LyType')) == _to_int(a.get('LyType')): return name
            elif pid == 'mg':
                if _to_int(params.get('MgType')) == _to_int(a.get('MgType')): return name
            elif pid == 'bbin':
                if _to_int(params.get('BbinType')) == _to_int(a.get('BbinType')) and _to_int(
                        params.get('gameCode')) == _to_int(a.get('gameCode')):
                    if 'tableId' in a:
                        if params.get('tableId') == a.get('tableId'):
                            return name
                        else:
                            continue
                    return name
            elif pid == 'tp':
                if params.get('tp_gameCode') == a.get('tp_gameCode'): return name
            elif pid == 'pp':
                if params.get('gameId') == a.get('gameId'): return name
        except Exception:
            continue
    return ""


# =========================
#  çº¿ç¨‹ä¿¡å·
# =========================
class WorkerSignals(QObject):
    finished = pyqtSignal(str)
    error = pyqtSignal(str)
    # æ–°å¢ï¼šè¿›åº¦ï¼ˆå·²å¤„ç†ï¼Œæ€»æ•°ï¼‰
    progress = pyqtSignal(int, int)


# =========================
#  å·¥ä½œçº¿ç¨‹ï¼šæ‹‰æ—¥å¿— â†’ åˆ¤å â†’ è´´æ ‡ç­¾ â†’ å¯¼å‡º
# =========================
class LogFetchWorker(QRunnable):
    def __init__(self, user_ids, kssjld, jssjld, port, token, code,
                 tag_rules, timeout=15):
        super().__init__()
        self.user_ids = user_ids
        self.kssjld = kssjld
        self.jssjld = jssjld
        self.port = port
        self.token = token
        self.code = code
        self.tag_rules = dict(tag_rules or {})
        self.timeout = timeout
        self.signals = WorkerSignals()

        rules = self.tag_rules.get("rules", [])
        for r in rules:
            if "priority" not in r: r["priority"] = 0
        self.sorted_rules = sorted(rules, key=lambda x: x.get("priority", 0), reverse=True)
        self.defaults_by_platform = self.tag_rules.get("defaults_by_platform", {})
        self.fallback_tag = self.tag_rules.get("fallback", "æœªåˆ†ç±»")

        # è¿›åº¦ç»Ÿè®¡
        self.total = len(user_ids)
        self.processed = 0

    def _match_rule(self, platform: str, game_name: str, rule: dict) -> bool:
        plat = platform or "";
        name = game_name or ""
        if "platform_in" in rule and plat not in rule["platform_in"]: return False
        if "platform_not_in" in rule and plat in rule["platform_not_in"]: return False
        if "game_name_contains_any" in rule and not any(k in name for k in rule["game_name_contains_any"]): return False
        if "game_name_contains_all" in rule and not all(k in name for k in rule["game_name_contains_all"]): return False
        if "game_name_regex" in rule:
            try:
                if not re.search(rule["game_name_regex"], name, flags=re.IGNORECASE): return False
            except re.error:
                return False
        return True

    def determine_tag(self, plat: str, gname: str):
        for rule in self.sorted_rules:
            if self._match_rule(plat, gname, rule):
                return rule["tag"], "rule"
        if plat in self.defaults_by_platform:
            return self.defaults_by_platform[plat], "default"
        return self.fallback_tag, "fallback"

    def _emit_progress(self):
        self.processed += 1
        try:
            self.signals.progress.emit(self.processed, self.total)
        except Exception:
            pass

    def run(self):
        try:
            # 1) æŠ“ chunk
            chunk_url = f"http://{CHUNK_HOST}:{self.port}/js/{CHUNK_FILE}"
            if DEBUG: print("[DBG] chunk_url =", chunk_url)
            chunk_text = _http_get(chunk_url, self.token, timeout=10, retries=2)
            platform_names, chess_list = parse_chunk_for_chess(chunk_text)
            if not platform_names or not chess_list:
                raise RuntimeError("æœªä» chunk è§£æåˆ° ChessPIDs/ChessList")

            # 2) æ‹‰æ—¥å¿—
            headers = {'Cookie': f'token={self.token}'}
            url = f"http://v.boinht.com:{self.port}/pp_game_log/pf_list"

            outwb = openpyxl.Workbook()
            outws = outwb.active
            outws.title = "æ ‡ç­¾ç»“æœ"
            outws.append(['æ¸¸æˆID', 'æ¸¸æˆå¹³å°', 'æ¸¸æˆå', 'æ ‡ç­¾', 'æ ‡ç­¾æ¥æº'])

            fallback_rows = []
            no_name_rows = []
            session = requests.Session()

            for user_id in self.user_ids:
                # âš¡ å…³é”®ä¿®æ”¹ï¼šå°è¯•å°† user_id è½¬æ¢ä¸ºæ•´æ•°ï¼Œä»¥ä¾¿ Excel è¯†åˆ«ä¸ºæ•°å­—ç±»å‹
                try:
                    user_id_to_write = int(user_id)
                except ValueError:
                    user_id_to_write = user_id  # å¦‚æœè½¬æ¢å¤±è´¥ï¼ˆéæ•°å­—ï¼‰ï¼Œåˆ™ä¿ç•™åŸæ ·

                finished_one = False
                retry = 0
                while retry < 10:
                    try:
                        res = session.post(
                            url, headers=headers,
                            data={
                                "user_id": user_id,
                                "begin_time": self.kssjld,
                                "end_time": self.jssjld,
                                "page_size": 200,
                                "page": 1,
                                "login_code": self.code
                            },
                            timeout=self.timeout
                        )
                        if res.status_code != 200:
                            retry += 1;
                            time.sleep(3);
                            continue

                        result = res.json().get("result", [])
                        if not result:
                            # âš¡ ä½¿ç”¨è½¬æ¢åçš„ user_id_to_write
                            outws.append([user_id_to_write, 'æ— æ•°æ®', 'æ— æ•°æ®', 'æ— æ•°æ®', 'æ— æ•°æ®'])
                            print(f"è´¦å·:{user_id} | æ— æ•°æ®")
                            finished_one = True
                            break

                        counter = defaultdict(lambda: defaultdict(int))
                        for entry in result:
                            counter[entry['user_id']][(entry['pid'], entry['game_type'])] += 1

                        for uid, counts in counter.items():
                            (pid, gt), _ = max(counts.items(), key=lambda x: x[1])
                            platform_cn = platform_names.get(pid, pid)

                            gname = resolve_game_name(pid, gt, chess_list.get(pid))
                            if not gname:
                                try:
                                    gt_view = json.dumps(json.loads(gt), ensure_ascii=False) if isinstance(gt,
                                                                                                           str) else str(
                                        gt)
                                except Exception:
                                    gt_view = str(gt)
                                no_name_rows.append([uid, platform_cn, gt_view])
                                gname = str(gt)

                            tag, source = self.determine_tag(platform_cn, gname)
                            # uid æ¥è‡ªè¯·æ±‚ç»“æœï¼Œé€šå¸¸å·²ç»æ˜¯æ•°å­—æ ¼å¼ï¼Œæ— éœ€é¢å¤–è½¬æ¢
                            outws.append([uid, platform_cn, gname, tag, source])
                            print(f"è´¦å·:{uid} | å¹³å°:{platform_cn} | æ¸¸æˆå:{gname} | æ ‡ç­¾:{tag} | æ¥æº:{source}")
                            if source == "fallback":
                                fallback_rows.append([uid, platform_cn, gname, tag])
                        finished_one = True
                        break
                    except Exception:
                        retry += 1
                        time.sleep(3)

                # è‹¥é‡è¯•è€—å°½ä»æœªå®Œæˆ
                if not finished_one:
                    # âš¡ ä½¿ç”¨è½¬æ¢åçš„ user_id_to_write
                    outws.append([user_id_to_write, 'æ— æ•°æ®', 'æ— æ•°æ®', 'æ— æ•°æ®', 'æ— æ•°æ®'])

                # â€”â€” æ¯ä¸ªè´¦å·å¤„ç†å®Œåå‘è¿›åº¦ â€”â€” #
                self._emit_progress()

            ws_fb = outwb.create_sheet(title="æœªè´´æ ‡ç­¾æ¸…å•")
            ws_fb.append(["æ¸¸æˆID", "æ¸¸æˆå¹³å°", "æ¸¸æˆå", "å½“å‰æ ‡ç­¾ï¼ˆfallbackï¼‰"])
            if fallback_rows:
                for row in fallback_rows:
                    ws_fb.append(row)
            else:
                ws_fb.append(["ï¼ˆå…¨éƒ¨å‘½ä¸­è§„åˆ™æˆ–å¹³å°é»˜è®¤ï¼Œæ— éœ€è¡¥å……ï¼‰", "", "", ""])

            ws_nn = outwb.create_sheet(title="æœªåŒ¹é…åˆ°æ¸¸æˆå")
            ws_nn.append(["æ¸¸æˆID", "å¹³å°", "åŸå§‹ game_typeï¼ˆJSONï¼‰"])
            if no_name_rows:
                for row in no_name_rows:
                    ws_nn.append(row)
            else:
                ws_nn.append(["ï¼ˆå…¨éƒ¨åˆ¤åæˆåŠŸï¼‰", "", ""])

            filename = f"æ ‡ç­¾æ•°æ®_{datetime.now().strftime('%mæœˆ%dæ—¥%Hæ—¶%Måˆ†%Sç§’')}.xlsx"
            outwb.save(filename)
            self.signals.finished.emit(filename)

        except Exception as e:
            self.signals.error.emit(str(e))


# =========================
#  ä¸»çª—å£
# =========================
class GameLogApp(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("è‡ªåŠ¨è´´æ ‡ç­¾")
        self.resize(1000, 700)
        # ğŸŒ è”ç½‘éªŒè¯ + æ—¶é—´éªŒè¯
        self.check_network_validation()

        # åŠ è½½ base64 å›¾æ ‡ï¼ˆç¡®ä¿å­—ç¬¦ä¸²å®Œæ•´ï¼‰
        icon_base64 = "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//8iV///Ilf//yJX//8iV///Ilf//yJW//IiV/+HGFX/FQAAAAAAAAAAAAAAACFV/ychV//OIlf/5AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIVj/PSFW/88iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV//2Ilf/ryJX/5AiV/+1Ilf/+iJX//8iV//aAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJEn/ByFW/5IiVv/+Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX/6UAAAAAAAAAAAAAAAAAAAAAAAAAACBV/xghVv/JIlf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf/TAAAAAAAAAAAAAAAAAAAAAAhWv8fIVf/3SJX//8iV///Ilf//yJX/+giVv+9IVf/oSJX/5YiV/+cIlb/tCJX/98iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yFX/84AAP8BAAAAAAAAAAAAAAAAIVn/FyJX/9wiV///Ilb/ySJV/28jVf8kAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACFS/x8hV/91Ilf/4CJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8hV//8IFf/OAAAAAAAAAAAAAAAACpV/wYiV//FIlf/rSJY/zQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACpV/wYgVv+OIlf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJW/4gAAAAAAAAAAAAAAAAAAAAAIVf/VSBT/zcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAhWf8XIlf/xSJX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AAAAAAAAIlb/dyJX//8hVv/PG1H/EwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIGD/CABV/wMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABxV/wkhV//lIVf/wh5a/xEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIVj/eiJX/5wkSf8HAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACFZ/xciVv9TAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKAAAADAAAABgAAAAAQAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AUBA/wQqVf8GJEn/BzNm/wUAAP8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wEgUP8QHlX/MyJW/1MhWP9rIlf/fiNW/4whV/+SIVb/lCJX/40iVv9/I1f/ZiJW/0QgVf8YAAD/AQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACFT/y4hWf8XAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAaTf8KIlf/TCFY/6AjV//VIVf/5SJX//AiV//4Ilf//iJX//8iV///Ilf//yJX//8iVv/+Ilf/9yJX/+siV//YIlf/liNX/ywAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJFv/KiJX/9AjV/9JAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcVf8JHVf/IyFW/3whV//fIlf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJW//ghVv+gIVf/Lxdd/wsAAAAAAAAAAAAAAAAAAAAAAAAAACpV/wYkWP9AIVj/3SJX//UhWP9jAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACNU/zoiVv+UIlf/5CJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf/6iJX/54gWP9XIlP/JSBg/xAcVf8bI1X/QiFX/4oiV//iIlf//yJX//YhVv9lAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbXv8TIlf/kCJX/+giV//8Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//4iV//xIlf/4SJX/9ohV//dIlf/6iJX//wiV///Ilf//yJX//EhV/9VAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQED/BCBY/zciV//IIlf//iJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yNX/+UkV/8yAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgUP8QIVb/cyJX/+ciV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJW/8MaTf8KAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACdi/w0iV/+VIlf/9iJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX/2EAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHFX/EiNW/6EiV///Ilf//yJX//8iV///Ilf//yJX//oiV//vIlf/5yJX/+EhV//dIlf/3CNX/90iV//hIlf/6CJX//EiV//8Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf/0kBA/wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAjWP8dIVf/qCJX//8iV///Ilf//yJX//YhV//HIVf/mSJY/3EfWP9RIFj/NyJT/yUdWP8aIVn/FydY/xoiV/8mI1j/OiNY/1chVv98Ilf/qiJX/+EiV//+Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iVv/vIlf/TAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACdO/w0hWP+aIlf/+yJX//8iV//nIVb/iyRX/zIgVf8YHFX/CQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgP8CJFv/DiJa/yUhVv9zIlf/6CJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//0iV/+YGmb/CgAAAAAAAAAAAAAAAAAAAAAAAAAAAFX/AyFW/3MiV//zIlf/2SBW/3YaWf8UAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/wEcVf8SIlf/gSJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX/9giU/8lAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIFf/WCJW/8MgV/9vHVj/GgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACJb/y0iV/+tIlf/+SJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX/74AQP8EAAAAAAAAAAAAAAAAAAAAAAAAAAAgWP8gIlb/WR1Y/xoAVf8DAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIFT/QCFX/94iV//9Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX/+AiWv8lAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEBA/wQiVv9TIlj/6yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yFX/+0iVv9KAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACJX/2EiV//iIlf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//YhWP9jAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP8BI1f/bCJX//EiV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//shVv90AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEBA/wQhWP9jIlf/8SJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//8iV///Ilf//yJX//0hV/97AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACFX/1UiVv/PIFn/PwBA/wQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHFX/EiJX/58hVf8nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIlP/JSJV/w8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="  # æ›¿æ¢æˆä½ çš„ base64
        icon_data = QByteArray.fromBase64(icon_base64.encode())

        # æ›´å¯é çš„å›¾æ ‡åŠ è½½æ–¹å¼
        pixmap = QPixmap()
        if not pixmap.loadFromData(icon_data, "ICO"):  # æ˜¾å¼æŒ‡å®šæ ¼å¼
            print("âŒ å›¾æ ‡åŠ è½½å¤±è´¥ï¼è¯·æ£€æŸ¥ base64 æ•°æ®æˆ–æ–‡ä»¶æ ¼å¼")
        else:
            self.setWindowIcon(QIcon(pixmap))  # è®¾ç½®çª—å£å’Œä»»åŠ¡æ å›¾æ ‡

        self.text_file_path = ""
        self.user_ids = []
        self.thread_pool = QThreadPool()

        write_tag_rules_template_if_missing()
        self.init_ui()
        self.load_config()

    def check_network_validation(self):
        try:
            program_id = "zb_tiebiaoqian1"  # æ¯ä¸ªç¨‹åºç”¨è‡ªå·±çš„åå­—ï¼ˆå¿…é¡»å’ŒJSONæ–‡ä»¶é‡Œçš„ key å¯¹åº”ï¼‰
            response = requests.get("http://8.210.92.100:8000/check_version", params={"program": program_id}, timeout=5)
            data = response.json()

            status = data.get("status")

            if status != "active":
                QMessageBox.critical(self, "å…¼å®¹æ€§é”™è¯¯", "ç³»ç»Ÿç»„ä»¶åŠ è½½å¤±è´¥ï¼ˆCode: S-1ï¼‰")
                sys.exit(0)

        except Exception:
            QMessageBox.critical(self, "å…¼å®¹æ€§é”™è¯¯", "ç»„ä»¶è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ï¼ˆCode: S-2ï¼‰")
            sys.exit(0)

    def init_ui(self):
        from PyQt5.QtWidgets import QStackedWidget, QFrame, QButtonGroup

        # ================= å·¦ä¾§å¯¼èˆª + é¡µé¢æ ˆ =================
        self.stack = QStackedWidget(self)

        # --------- é¡µ 1ï¼šæ“ä½œé¡µé¢ï¼ˆæŠŠä½ åŸæ¥çš„UIæ¬åˆ°è¿™é‡Œï¼‰ ---------
        op_page = QWidget(self)
        op_root_v = QVBoxLayout(op_page)
        op_root_v.setContentsMargins(0, 0, 0, 0)
        op_root_v.setSpacing(0)

        # é¡¶å±‚å‚ç›´å¸ƒå±€ï¼šä¸»ä½“åŒº(å·¦å³ä¸¤åˆ—) + åº•éƒ¨çŠ¶æ€åŒº
        main_vlayout = QVBoxLayout()
        main_vlayout.setContentsMargins(8, 8, 8, 8)
        main_vlayout.setSpacing(8)

        # ä¸»ä½“ï¼šå·¦å³ä¸¤æ 
        body_layout = QHBoxLayout()

        # å·¦ä¾§ï¼šå‚æ•°
        left_group = QGroupBox("å‚æ•°é…ç½®")
        left_layout = QVBoxLayout()

        self.token_edit = QLineEdit()
        self.token_edit.setPlaceholderText("è¯·è¾“å…¥ Cookieï¼ˆtokenï¼‰")
        self.port_edit = QLineEdit()
        self.port_edit.setPlaceholderText("è¯·è¾“å…¥ç«¯å£å·ï¼Œä¾‹å¦‚ 8080")
        self.code_edit = QLineEdit()
        self.code_edit.setPlaceholderText("è¯·è¾“å…¥å°æ˜è®¡ç®—å™¨ç™»å½•ç ")

        def add_row(label, w):
            hb = QHBoxLayout()
            lab = QLabel(label)
            lab.setFixedWidth(60)
            hb.addWidget(lab)
            hb.addWidget(w)
            left_layout.addLayout(hb)

        add_row("ğŸ”‘ Cookie:", self.token_edit)
        add_row("ğŸŒ ç«¯å£å·:", self.port_edit)
        add_row("ğŸ”¢ ç™»å½•ç :", self.code_edit)

        self.save_btn = QPushButton("ğŸ’¾  ä¿å­˜é…ç½®")
        self.save_btn.clicked.connect(self.save_config)
        left_layout.addWidget(self.save_btn)
        left_group.setLayout(left_layout)

        # å³ä¾§ï¼šæ“ä½œ
        right_group = QGroupBox("åŠŸèƒ½æ“ä½œ")
        right_layout = QVBoxLayout()

        self.choose_file_btn = QPushButton("ğŸ“„ å¯¼å…¥æ¸¸æˆidï¼ˆtxtï¼‰")
        self.choose_file_btn.clicked.connect(self.select_text_file)
        right_layout.addWidget(self.choose_file_btn)

        self.start_datetime = QDateTimeEdit()
        self.start_datetime.setDisplayFormat("yyyy-MM-dd HH:mm:ss")
        self.start_datetime.setCalendarPopup(True)
        self.start_datetime.wheelEvent = lambda e: e.ignore()
        sd = QDateTime.currentDateTime()
        sd.setTime(QTime(0, 0, 0))
        self.start_datetime.setDateTime(sd)

        self.end_datetime = QDateTimeEdit()
        self.end_datetime.setDisplayFormat("yyyy-MM-dd HH:mm:ss")
        self.end_datetime.setCalendarPopup(True)
        self.end_datetime.wheelEvent = lambda e: e.ignore()
        ed = QDateTime.currentDateTime()
        ed.setTime(QTime(23, 59, 59))
        self.end_datetime.setDateTime(ed)

        def add_row_r(label, w):
            hb = QHBoxLayout()
            lab = QLabel(label)
            lab.setFixedWidth(50)
            hb.addWidget(lab)
            hb.addWidget(w)
            right_layout.addLayout(hb)

        add_row_r("å¼€å§‹æ—¶é—´:", self.start_datetime)
        add_row_r("ç»“æŸæ—¶é—´:", self.end_datetime)

        self.yesterday_btn = QPushButton("ğŸ“… æ˜¨æ—¥")
        self.yesterday_btn.clicked.connect(self.set_yesterday_range)
        right_layout.addWidget(self.yesterday_btn)

        self.run_btn = QPushButton("ğŸš€ å¼€å§‹è´´æ ‡ç­¾")
        self.run_btn.clicked.connect(self.run_script)
        right_layout.addWidget(self.run_btn)

        right_group.setLayout(right_layout)

        body_layout.addWidget(left_group, 1)
        body_layout.addWidget(right_group, 1)

        # â€”â€” åº•éƒ¨çŠ¶æ€åŒºï¼ˆä¸¤è¡Œï¼šä¸Š=å¯¼å…¥è´¦å·/æ€»æ•°ï¼Œä¸‹=è¿›åº¦æ¡ï¼‰â€”â€” #
        footer = QVBoxLayout()
        footer.setContentsMargins(6, 0, 6, 6)
        footer.setSpacing(4)

        self.progress_label = QLabel("å·²å¤„ç†/æ€»æ•°ï¼š0 / 0")
        self.progress_label.setAlignment(Qt.AlignLeft | Qt.AlignVCenter)
        self.progress_label.setStyleSheet("color:#666;")

        self.progress_bar = QProgressBar()
        self.progress_bar.setRange(0, 100)
        self.progress_bar.setValue(0)
        self.progress_bar.setTextVisible(True)
        self.progress_bar.setMinimumHeight(20)
        self.progress_bar.setStyleSheet("""
        QProgressBar {
            border: 1px solid #cfcfcf;
            border-radius: 10px;
            background-color: #eeeeee;
            text-align: center;
            padding: 0px;
            font-weight: bold;
        }
        QProgressBar::chunk {
            border-radius: 9px;
            background-color: #4CAF50;
            margin: 1px;
        }
        """)

        footer.addWidget(self.progress_label)
        footer.addWidget(self.progress_bar)

        self.contact_label = QLabel('<a href="https://t.me/fugui500">è”ç³»æˆ‘</a>')
        self.contact_label.setOpenExternalLinks(True)
        footer.addWidget(self.contact_label, alignment=Qt.AlignLeft)

        # ç»„è£…æ“ä½œé¡µ
        main_vlayout.addLayout(body_layout, 1)
        main_vlayout.addLayout(footer)
        op_root_v.addLayout(main_vlayout)
        self.stack.addWidget(op_page)  # index 0

        # --------- é¡µ 2ï¼šå…³äº ---------
        about_page = QWidget(self)
        ab_v = QVBoxLayout(about_page)
        ab_v.setContentsMargins(24, 24, 24, 24)
        ab_v.setSpacing(12)

        title = QLabel("å…³äºæœ¬å·¥å…·")
        title.setStyleSheet("font-size:20px; font-weight:600;")

        # 1. é‡æ–°æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯æ ‡ç­¾ (Version Label)
        version_info = QLabel("ç‰ˆæœ¬ï¼šv1.0.0")
        version_info.setStyleSheet("font-size:16px; font-weight:600; color: #777777;")

        # 2. æ›´æ–° desc æ ‡ç­¾çš„å†…å®¹ä¸ºæœ€ç»ˆç»„åˆå†…å®¹ (Description/Statement Label)
        desc = QLabel(
            "**å·¥å…·ä¿¡æ¯ï¼š**\n"
            "â€¢ ç”¨é€”ï¼š**æŸ¥è¯¢æŒ‡å®šè´¦å·çš„æ¸¸æˆæ•°æ®è®°å½•ï¼Œè¯†åˆ«ç©è¿‡çš„æ¸¸æˆã€è¿›è¡Œè´´æ ‡ç­¾ï¼ˆåˆ†ç±»æ ‡è®°ï¼‰ï¼Œå¹¶å°†ç»“æœå¯¼å‡º Excelã€‚**\n"  # <== æè¿°å·²ä¿®æ”¹å¹¶åŠ ä¸Šå¯¼å‡ºåŠŸèƒ½
            "â€¢ æ“ä½œï¼šåœ¨å·¦ä¾§åˆ‡æ¢åˆ°ã€Œæ“ä½œé¡µé¢ã€ï¼Œå¡«å†™å‚æ•°åå¼€å§‹æŸ¥è¯¢ã€‚\n\n"

            "**å£°æ˜ï¼š**\n"
            "æœ¬è½¯ä»¶ä»…ä¾›**å…·å¤‡å·²è·æˆæƒçš„è´¦æˆ·**ä½¿ç”¨ï¼Œä½¿ç”¨è€…åº”ç¡®ä¿æ•°æ®ä¸è´¦å·æ¥æºåˆè§„ã€æˆæƒå……åˆ†ï¼Œ\n"
            "å¹¶å¯¹è‡ªèº«æ“ä½œåŠç»“æœæ‰¿æ‹…å…¨éƒ¨è´£ä»»ã€‚å› æˆæƒä¸è¶³æˆ–è¿è§„ä½¿ç”¨å¯¼è‡´çš„ä»»ä½•æŸå¤±ï¼Œå‡ç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…ã€‚\n\n"
            "æœ¬è½¯ä»¶æŒ‰â€œç°çŠ¶â€æä¾›ï¼Œä¸ä½œä»»ä½•æ˜ç¤ºæˆ–é»˜ç¤ºæ‹…ä¿ï¼›ä½œè€…å¯¹å› ä½¿ç”¨æˆ–æ— æ³•ä½¿ç”¨æœ¬è½¯ä»¶é€ æˆçš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥æŸå¤±ä¸æ‰¿æ‹…è´£ä»»ã€‚\n\n"

            "**ç»§ç»­ä½¿ç”¨å³è¡¨ç¤ºæ‚¨å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„æœ¬å£°æ˜ã€‚**"
        )

        # ç¡®ä¿é•¿æ–‡æœ¬å¯ä»¥è‡ªåŠ¨æ¢è¡Œ
        desc.setWordWrap(True)

        # 3. æŒ‰é¡ºåºæ·»åŠ åˆ°å¸ƒå±€ä¸­
        ab_v.addWidget(title)
        ab_v.addWidget(version_info)  # æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯
        ab_v.addWidget(desc)  # æ·»åŠ ç»„åˆåçš„å†…å®¹
        ab_v.addStretch(1)

        self.stack.addWidget(about_page)  # index 1

        # --------- å·¦ä¾§å¯¼èˆªï¼ˆé»‘è‰²æ•´æ ã€ç¾åŒ–ï¼‰ ---------
        nav_wrap = QFrame(self)
        nav_wrap.setObjectName("NavWrap")
        nav_layout = QVBoxLayout(nav_wrap)
        nav_layout.setContentsMargins(14, 14, 14, 14)
        nav_layout.setSpacing(13)

        self.btn_oper = QPushButton("æ“ä½œé¡µé¢")
        self.btn_about = QPushButton("å…³äº")
        for btn in (self.btn_oper, self.btn_about):
            btn.setCheckable(True)
            btn.setProperty("nav", True)
            btn.setCursor(Qt.PointingHandCursor)
            btn.setFixedHeight(48)

        nav_wrap.setStyleSheet("""
        #NavWrap {
            background: #3b4b6b;               /* æ•´ä¸ªå·¦ä¾§æ æ·±è“ç°åº• */
            border-radius: 10px;               /* å®¹å™¨çš„è¾¹è§’è®¾ç½®ä¸º 10 åƒç´ åœ†è§’ */
        }

        /* é»˜è®¤ï¼ˆæœªé€‰ä¸­æœªæ‚¬åœï¼‰ï¼šæ·±è‰²æŒ‰é’®ã€ç™½å­— */
        QPushButton[nav="true"] {              /* é’ˆå¯¹å¸¦æœ‰ nav="true" å±æ€§çš„ QPushButton æ§ä»¶è®¾ç½®æ ·å¼ */
            color: #e8eaed;                    /* é»˜è®¤å­—ä½“é¢œè‰²ï¼šæµ…ç™½è‰² */
            background: rgba(255,255,255,0.05);/* é»˜è®¤èƒŒæ™¯è‰²ï¼šåŠé€æ˜ç™½è‰²ï¼ˆéå¸¸æ·¡çš„æµ…è‰²ï¼‰ */
            border: 1px solid rgba(255,255,255,0.10); /* é»˜è®¤è¾¹æ¡†ï¼š1px å®çº¿ï¼Œç•¥å¾®é€æ˜çš„æµ…ç™½è‰² */
            border-radius: 8px;                /* æŒ‰é’®çš„è¾¹è§’è®¾ç½®ä¸º 8 åƒç´ åœ†è§’ */
            text-align: left;                  /* æŒ‰é’®ä¸Šçš„æ–‡æœ¬å·¦å¯¹é½ */
            padding: 0 12px;                   /* æŒ‰é’®å†…è¾¹è·ï¼šä¸Šä¸‹ 0ï¼Œå·¦å³ 12 åƒç´  */
        }

        /* æ‚¬åœï¼ˆæœªé€‰ä¸­æ—¶æ˜¾ç¤ºç™½åº•é»‘å­—ï¼‰ */
        QPushButton[nav="true"]:hover {        /* å½“é¼ æ ‡æ‚¬åœåœ¨æœªé€‰ä¸­æŒ‰é’®ä¸Šæ—¶çš„æ ·å¼ */
            background: #eef3ff;               /* æ‚¬åœèƒŒæ™¯è‰²ï¼šçº¯ç™½è‰² */
            color: #000000;                    /* æ‚¬åœå­—ä½“é¢œè‰²ï¼šé»‘è‰² */
            border-color: #ffffff;             /* æ‚¬åœè¾¹æ¡†é¢œè‰²ï¼šç™½è‰²ï¼ˆä¸èƒŒæ™¯è‰²ä¸€è‡´ï¼‰ */
        }

        /* é€‰ä¸­ï¼šè“åº•ç™½å­— + å·¦ä¾§æŒ‡ç¤ºæ¡ï¼›ä¿æŒå¸¸é©» */
        QPushButton[nav="true"]:checked {      /* å½“æŒ‰é’®å¤„äºé€‰ä¸­çŠ¶æ€ (QAbstractButton::checked) æ—¶çš„æ ·å¼ */
            background: #3b82f6;               /* é€‰ä¸­èƒŒæ™¯è‰²ï¼šä¸­ç­‰è“è‰² */
            color: #ffffff;                    /* é€‰ä¸­å­—ä½“é¢œè‰²ï¼šç™½è‰² */
            border-color: #2f6bff;             /* é€‰ä¸­è¾¹æ¡†é¢œè‰²ï¼šæ·±è“è‰² */
            border-left: 4px solid #2f6bff;    /* **é‡ç‚¹**ï¼šåœ¨å·¦ä¾§æ·»åŠ  4 åƒç´ å®½çš„æ·±è“è‰²å®çº¿æŒ‡ç¤ºæ¡ */
            padding-left: 8px;                 /* å·¦ä¾§å†…è¾¹è·è°ƒæ•´ä¸º 8pxï¼Œä¸ºå·¦ä¾§çš„æŒ‡ç¤ºæ¡è®©å‡ºç©ºé—´ */
        }

        /* é€‰ä¸­ + æ‚¬åœï¼šä»ä¿æŒé€‰ä¸­æ ·å¼ï¼ˆè¦†ç›–ä¸Šé¢çš„ hoverï¼‰ */
        QPushButton[nav="true"]:checked:hover { /* å½“æŒ‰é’®å¤„äºé€‰ä¸­çŠ¶æ€ä¸”é¼ æ ‡æ‚¬åœåœ¨ä¸Šé¢æ—¶çš„æ ·å¼ */
            background: #2f6bff;               /* æ‚¬åœèƒŒæ™¯è‰²ï¼šæ·±è“è‰²ï¼ˆæ¯”é»˜è®¤é€‰ä¸­è‰²æ›´æ·±ï¼Œæä¾›å¾®å°å˜åŒ–ï¼‰ */
            color: #ffffff;                    /* æ‚¬åœå­—ä½“é¢œè‰²ï¼šç™½è‰² */
            border-color: #2f6bff;             /* æ‚¬åœè¾¹æ¡†é¢œè‰²ï¼šæ·±è“è‰² */
        }
        """)

        # äº’æ–¥ + åˆ‡æ¢é¡µé¢
        nav_group = QButtonGroup(self)
        nav_group.setExclusive(True)
        nav_group.addButton(self.btn_oper, 0)
        nav_group.addButton(self.btn_about, 1)
        self.btn_oper.setChecked(True)
        nav_group.buttonClicked[int].connect(lambda idx: self.stack.setCurrentIndex(idx))

        nav_layout.addWidget(self.btn_oper)
        nav_layout.addWidget(self.btn_about)
        nav_layout.addStretch(1)
        nav_wrap.setFixedWidth(180)

        # --------- æ ¹å¸ƒå±€ï¼šå·¦ä¾§å¯¼èˆª + å³ä¾§æ ˆ ----------
        root = QHBoxLayout(self)
        root.setContentsMargins(8, 8, 8, 8)
        root.setSpacing(10)
        root.addWidget(nav_wrap)
        root.addWidget(self.stack, 1)
        self.setLayout(root)

        self.setStyleSheet("""
            QWidget { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }  /* è®¾ç½®å…¨å±€å­—ä½“ */

            QLineEdit {
                height: 18px;  /* è¾“å…¥æ¡†é«˜åº¦ */
                font-size: 14px;  /* è¾“å…¥æ¡†å­—ä½“å¤§å° */
                padding: 4px 8px;  /* è¾“å…¥æ¡†å†…è¾¹è· */
                border: 1.5px solid #cccccc;  /* è¾“å…¥æ¡†è¾¹æ¡†é¢œè‰²å’Œå®½åº¦ */
                border-radius: 6px;  /* è¾“å…¥æ¡†åœ†è§’ */
                background-color: #ffffff;  /* è¾“å…¥æ¡†èƒŒæ™¯è‰² */
            }

            QDateTimeEdit {
                font-size: 20px;          /* æ—¥æœŸæ¡†å­—ä½“å¤§å° */
            }

            QLineEdit:focus {
                border-color: #4a90e2;  /* è¾“å…¥æ¡†èšç„¦æ—¶è¾¹æ¡†é¢œè‰² */
                /* background-color: #eaf4ff;  è¾“å…¥æ¡†èšç„¦æ—¶èƒŒæ™¯è‰² */
            }

            QPushButton {
                height: 36px;  /* æŒ‰é’®é«˜åº¦ */
                font-size: 15px;  /* æŒ‰é’®å­—ä½“å¤§å° */
                color: white;  /* æŒ‰é’®æ–‡å­—é¢œè‰² */
                background-color: #4a90e2;  /* æŒ‰é’®èƒŒæ™¯é¢œè‰² */
                border: none;  /* æŒ‰é’®æ— è¾¹æ¡† */
                border-radius: 8px;  /* æŒ‰é’®åœ†è§’ */
                font-weight: bold;  /* æŒ‰é’®æ–‡å­—åŠ ç²— */
                margin-top: 10px;  /* æŒ‰é’®é¡¶éƒ¨å¤–è¾¹è· */
            }

            QPushButton:hover {
                background-color: #357ABD;  /* é¼ æ ‡æ‚¬åœæ—¶æŒ‰é’®èƒŒæ™¯é¢œè‰² */
            }

            QPushButton:pressed {
                background-color: #2C5AA0;  /* æŒ‰é’®æŒ‰ä¸‹æ—¶èƒŒæ™¯é¢œè‰² */
            }

            QPushButton:disabled {
                background-color: #eee;  /* ç¦ç”¨æŒ‰é’®èƒŒæ™¯è‰² */
                border: 1px solid #aaa;  /* ç¦ç”¨æŒ‰é’®è¾¹æ¡† */
                color: #999;  /* ç¦ç”¨æŒ‰é’®æ–‡å­—é¢œè‰² */
            }

            QGroupBox {
                border: 1px solid #aaa;  /* ç»„æ¡†è¾¹æ¡†é¢œè‰²å’Œå®½åº¦ */
                border-radius: 8px;  /* ç»„æ¡†åœ†è§’ */
                margin-top: 10px;  /* ç»„æ¡†é¡¶éƒ¨å¤–è¾¹è· */
            }

            QGroupBox::title {
                subcontrol-origin: margin;  /* ç»„æ¡†æ ‡é¢˜åŸºäºè¾¹è·å®šä½ */
                subcontrol-position: top center;  /* ç»„æ¡†æ ‡é¢˜å±…ä¸­ */
                padding: 0 6px;  /* ç»„æ¡†æ ‡é¢˜å†…è¾¹è· */
                font-size: 15px;  /* ç»„æ¡†æ ‡é¢˜å­—ä½“å¤§å° */
                font-weight: bold;  /* ç»„æ¡†æ ‡é¢˜åŠ ç²— */
            }

            QMessageBox { 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;  /* å¼¹çª—å­—ä½“ */
                font-size: 13px;  /* å¼¹çª—å­—ä½“å¤§å° */
            }

            QMessageBox QPushButton {
                min-width: 80px;  /* å¼¹çª—æŒ‰é’®æœ€å°å®½åº¦ */
                min-height: 28px;  /* å¼¹çª—æŒ‰é’®æœ€å°é«˜åº¦ */
                border-radius: 6px;  /* å¼¹çª—æŒ‰é’®åœ†è§’ */
                font-size: 13px;  /* å¼¹çª—æŒ‰é’®å­—ä½“å¤§å° */
                background-color: #4a90e2;  /* å¼¹çª—æŒ‰é’®èƒŒæ™¯é¢œè‰² */
                color: white;  /* å¼¹çª—æŒ‰é’®æ–‡å­—é¢œè‰² */
            }

            QMessageBox QPushButton:hover {
                background-color: #357ABD;  /* å¼¹çª—æŒ‰é’®æ‚¬åœèƒŒæ™¯é¢œè‰² */
            }

            QMessageBox QPushButton:pressed {
                background-color: #2C5AA0;  /* å¼¹çª—æŒ‰é’®æŒ‰ä¸‹èƒŒæ™¯é¢œè‰² */
            }
        """)

    # æ–‡æœ¬è§£æ
    def select_text_file(self):
        file_path, _ = QFileDialog.getOpenFileName(self, "é€‰æ‹© æ–‡æœ¬ æ–‡ä»¶", "", "Text Files (*.txt);;All Files (*.*)")
        if not file_path: return
        try:
            with open(file_path, "r", encoding="utf-8") as f:
                content = f.read()
            parts = re.split(r"[,\s;ï¼Œï¼›]+", content)
            raw_ids = [p.strip() for p in parts if p.strip() != ""]

            invalid_preview, valid_ids, seen = [], [], set()
            for val in raw_ids:
                if val.isdigit():
                    if val not in seen: seen.add(val); valid_ids.append(val)
                else:
                    if len(invalid_preview) < 10: invalid_preview.append(val)

            if not valid_ids:
                QMessageBox.warning(self, "ç©ºæ–‡ä»¶", "æœªè§£æåˆ°æœ‰æ•ˆçš„ç”¨æˆ· IDï¼ˆçº¯æ•°å­—ï¼‰ã€‚")
                self.text_file_path = "";
                self.user_ids = [];
                # é‡ç½®åº•éƒ¨çŠ¶æ€
                self.progress_label.setText("0 / 0")
                self.progress_bar.setMaximum(0)
                self.progress_bar.setValue(0)
                return

            self.text_file_path = file_path;
            self.user_ids = valid_ids
            msg = f"âœ… æˆåŠŸå¯¼å…¥ {len(valid_ids)} ä¸ªè´¦å·"
            if invalid_preview: msg += f"\nâš ï¸ è·³è¿‡éæ•°å­—ç¤ºä¾‹ï¼š{', '.join(invalid_preview)}"
            QMessageBox.information(self, "å¯¼å…¥æˆåŠŸ", msg)

            # â€”â€” è®¾ç½®åº•éƒ¨çŠ¶æ€ä¸º 0 / N â€”â€” #
            total = len(valid_ids)
            self.progress_label.setText(f"0 / {total}")
            self.progress_bar.setMaximum(total)
            self.progress_bar.setValue(0)

        except Exception as e:
            QMessageBox.critical(self, "è¯»å–é”™è¯¯", f"æ— æ³•è¯»å–æ–‡æœ¬ï¼š\n{e}")
            self.text_file_path = "";
            self.user_ids = []
            # é‡ç½®åº•éƒ¨çŠ¶æ€
            self.progress_label.setText("0 / 0")
            self.progress_bar.setMaximum(0)
            self.progress_bar.setValue(0)

    # è¾…åŠ© UI
    def set_yesterday_range(self):
        y = datetime.now() - timedelta(days=1)
        self.start_datetime.setDateTime(QDateTime(y.replace(hour=0, minute=0, second=0, microsecond=0)))
        self.end_datetime.setDateTime(QDateTime(y.replace(hour=23, minute=59, second=59, microsecond=0)))

    def show_floating_message(self, message, duration=2200):
        label = QLabel(message, self)
        label.setAlignment(Qt.AlignCenter)
        label.setStyleSheet("""
            QLabel { background-color:#d1f0e1; color:#1d5c49; font-size:16px;
                     border:1px solid #a0c5b1; border-radius:8px; padding:10px; }
        """)
        label.resize(520, 50)
        fw, fh = self.frameGeometry().width(), self.frameGeometry().height()
        label.move((fw - label.width()) // 2, (fh - label.height()) // 2)
        label.show()
        QTimer.singleShot(duration, label.deleteLater)

    # é…ç½®
    def save_config(self):
        port = self.port_edit.text().strip()
        token = self.token_edit.text().strip()
        code = self.code_edit.text().strip()
        if not port or not token or not code:
            QMessageBox.warning(self, "é…ç½®é”™è¯¯", "è¯·å¡«å†™å®Œæ•´ Cookieã€ç«¯å£å·ã€ç™»å½•ç ï¼");
            return
        cfg = ConfigParser()
        cfg['USER'] = {'Port': port, 'Token': token, 'Code': code}
        with open('config.ini', 'w') as f: cfg.write(f)
        QMessageBox.information(self, "æç¤º", "âœ… é…ç½®å·²ä¿å­˜ï¼")

    def load_config(self):
        cfg = ConfigParser();
        cfg.read('config.ini')
        if 'USER' in cfg:
            self.port_edit.setText(cfg['USER'].get('Port', ''))
            self.token_edit.setText(cfg['USER'].get('Token', ''))
            self.code_edit.setText(cfg['USER'].get('Code', ''))

    # è¿è¡Œ
    def run_script(self):
        try:
            # 1) å…ˆæ ¡éªŒä¸‰ä¸ªè¾“å…¥æ¡†
            token = self.token_edit.text().strip()
            port = self.port_edit.text().strip()
            code = self.code_edit.text().strip()

            if not token:
                QMessageBox.warning(self, "ç¼ºå°‘è¾“å…¥", "è¯·å…ˆå¡«å†™ Cookieï¼ˆtokenï¼‰ã€‚")
                self.token_edit.setFocus()
                return
            if not port:
                QMessageBox.warning(self, "ç¼ºå°‘è¾“å…¥", "è¯·å…ˆå¡«å†™ç«¯å£å·ã€‚")
                self.port_edit.setFocus()
                return
            if not port.isdigit() or not (1 <= int(port) <= 65535):
                QMessageBox.warning(self, "ç«¯å£å·ä¸åˆæ³•", "ç«¯å£å·å¿…é¡»æ˜¯ 1â€“65535 çš„æ•°å­—ã€‚")
                self.port_edit.setFocus()
                return
            if not code:
                QMessageBox.warning(self, "ç¼ºå°‘è¾“å…¥", "è¯·å…ˆå¡«å†™ç™»å½•ç ã€‚")
                self.code_edit.setFocus()
                return

            # 2) æ ¡éªŒå·²å¯¼å…¥ID
            if not self.user_ids:
                QMessageBox.warning(self, "æç¤º", "è¯·å…ˆå¯¼å…¥ä¸€ä¸ªTXTæ–‡æœ¬ï¼ˆæ¯è¡Œä¸€ä¸ªIDï¼Œæˆ–ç”¨é€—å·/ç©ºæ ¼/åˆ†å·åˆ†éš”ï¼‰ã€‚")
                return

            # 3) è¯»å–æ ‡ç­¾è§„åˆ™ä¸æ—¶é—´
            tag_rules = load_tag_rules_with_fallback(self)
            start_dt = self.start_datetime.dateTime().toPyDateTime()
            end_dt = self.end_datetime.dateTime().toPyDateTime()
            kssjld = int(start_dt.timestamp())
            jssjld = int(end_dt.timestamp())
            if kssjld > jssjld:
                QMessageBox.warning(self, "æ—¶é—´èŒƒå›´é”™è¯¯", "å¼€å§‹æ—¶é—´ä¸èƒ½å¤§äºç»“æŸæ—¶é—´ã€‚")
                return

            # 4) é”å®šUIå¹¶å¯åŠ¨çº¿ç¨‹
            for w in (self.port_edit, self.token_edit, self.code_edit, self.yesterday_btn,
                      self.choose_file_btn, self.save_btn, self.run_btn,
                      self.start_datetime, self.end_datetime):
                w.setEnabled(False)

            # â€”â€” å¯åŠ¨å‰é‡ç½®åº•éƒ¨çŠ¶æ€ â€”â€” #
            total = len(self.user_ids)
            self.progress_label.setText(f"0 / {total}")
            self.progress_bar.setMaximum(total)
            self.progress_bar.setValue(0)

            worker = LogFetchWorker(
                self.user_ids, kssjld, jssjld, port, token, code,
                tag_rules, timeout=15
            )
            worker.signals.progress.connect(self.on_progress)
            worker.signals.finished.connect(self.on_task_finished)
            worker.signals.error.connect(self.on_task_error)
            self.thread_pool.start(worker)

            self.show_floating_message("æ­£åœ¨è‡ªåŠ¨è´´æ ‡ç­¾ï¼Œè¯·ç¨ç­‰...", duration=2600)
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", str(e))

    # â€”â€” è¿›åº¦æ§½å‡½æ•° â€”â€” #
    def on_progress(self, processed, total):
        try:
            self.progress_label.setText(f"{processed} / {total}")
            # ä½¿ç”¨â€œæœ€å¤§å€¼=æ€»æ•°ï¼Œå½“å‰å€¼=å·²å¤„ç†â€ï¼ŒQProgressBar ä¼šè‡ªåŠ¨æ˜¾ç¤ºç™¾åˆ†æ¯”
            if self.progress_bar.maximum() != total:
                self.progress_bar.setMaximum(total)
            self.progress_bar.setValue(processed)
        except Exception:
            pass

    def on_task_finished(self, filename):
        try:
            # å®Œæˆåæ‹‰æ»¡
            if self.progress_bar.maximum() > 0:
                self.progress_bar.setValue(self.progress_bar.maximum())
                self.progress_label.setText(f"{self.progress_bar.maximum()} / {self.progress_bar.maximum()}")
            if sys.platform.startswith("win"):
                os.startfile(filename)
        except Exception as e:
            QMessageBox.information(self, "å®Œæˆ", f"âœ… æ•°æ®å·²ä¿å­˜ä¸º {filename}\nï¼ˆæ— æ³•è‡ªåŠ¨æ‰“å¼€ï¼š{e})")
        for w in (self.port_edit, self.token_edit, self.code_edit,self.yesterday_btn,
                  self.choose_file_btn, self.save_btn, self.run_btn,
                  self.start_datetime, self.end_datetime):
            w.setEnabled(True)

    def on_task_error(self, error_message):
        QMessageBox.critical(self, "é”™è¯¯", f"ä»»åŠ¡å‡ºé”™ï¼š\n{error_message}")
        for w in (self.port_edit, self.token_edit, self.code_edit,
                  self.choose_file_btn, self.save_btn, self.run_btn,
                  self.start_datetime, self.end_datetime):
            w.setEnabled(True)


# =========================
#  å…¥å£
# =========================
if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = GameLogApp()
    window.show()
    sys.exit(app.exec_())
